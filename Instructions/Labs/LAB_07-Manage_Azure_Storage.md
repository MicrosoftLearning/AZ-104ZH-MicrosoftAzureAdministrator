---
lab:
    title: '07 - 管理 Azure 存储'
    module: '模块 07 - Azure 存储'
---

# 实验室 07 - 管理 Azure 存储
# 学生实验室手册

## 实验室场景

你需要评估可否使用 Azure 存储来存储当前位于本地数据存储中的文件。虽然不经常访问其中大部分文件，但也有一些例外。你希望将访问频率较低的文件放在价格较低的存储层中，以最大程度地降低存储成本。你还计划探索 Azure 存储提供的不同保护机制，包括网络访问、身份验证、授权和复制。最后，你想确定 Azure 文件存储服务有多适合用于托管本地文件共享。

## 目标

在本实验室中，你将：

+ 任务 1：预配实验室环境
+ 任务 2：创建和配置 Azure 存储帐户 
+ 任务 3： 管理 Blob 存储
+ 任务 4： 管理 Azure 存储的身份验证和授权
+ 任务 5：创建并配置 Azure 文件存储共享
+ 任务 6： 管理 Azure 存储的网络访问

## 预计用时：40 分钟

## 说明

### 练习 1

#### 任务 1：预配实验室环境

在此任务中，你将部署一个 Azure 虚拟机，稍后将在本实验室中用到。 

1. 登录到 [Azure 门户](https://portal.azure.com)。

1. 在 Azure 门户中，单击 Azure 门户右上方的图标，打开 **Azure Cloud Shell**。

1. 提示选择 **Bash** 或 **PowerShell** 时，选择 **PowerShell**。 

    >**注意**：如果这是第一次启动 **Cloud Shell**，且看到 **“未装载任何存储”** 消息，请选择在本实验室中使用的订阅，然后选择 **“创建存储”**。 

1. 在 Cloud Shell 窗格的工具栏中，单击**上传/下载文件** 图标，然后在下拉菜单中单击 **“上传”**，并将文件 **\\Allfiles\\Module_07\\az104-07-vm-template.json** 和 **\\Allfiles\\Module_07\\az104-07-vm-parameters.json** 上传到 Cloud Shell 主目录中。

1. 在 Cloud Shell 窗格中运行以下命令，以创建将托管虚拟机的资源组（将 `[Azure_region]` 占位符替换为你打算在其中部署 Azure 虚拟机的 Azure 区域的名称）：

    >**注意**： 要列出 Azure 区域的名称，请运行 `(Get-AzLocation).Location`

   ```pwsh
   $location = '[Azure_region]'

   $rgName = 'az104-07-rg0'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 在 Cloud Shell 窗格中运行以下命令，通过使用上传的模板和参数文件来部署虚拟机：

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-07-vm-template.json `
      -TemplateParameterFile $HOME/az104-07-vm-parameters.json `
      -AsJob
   ```

    >**注意**：请不要等待部署完成，而是继续执行下一个任务。 

1. 关闭 Cloud Shell 窗格。

#### 任务 2：创建和配置 Azure 存储帐户 

在此任务中，你将创建和配置 Azure 存储帐户。 

1. 在 Azure 门户中，搜索并选择 **“存储帐户”**，然后单击 **“+ 添加”**。 

1. 在 **“创建存储帐户”** 边栏选项卡的 **“基本设置”** 选项卡上，指定以下设置（其他设置则保留为默认值）：

    | 设置 | 值 | 
    | --- | --- |
    | 订阅 | 在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **新**资源组名称 **az104-07-rg1** |
    | 存储帐户名称 | 由字母和数字组成、介于 3-24 个字符的任何全局唯一名称 |
    | 位置 | 可以在其中创建 Azure 存储帐户的 Azure 区域的名称  |
    | 性能 | **标准** |
    | 帐户类型 | **存储（常规用途 v1）** |
    | 复制 | **读取访问异地冗余存储 (RA-GRS)** |

1. 单击 **“下一步: 联网 >”**，在 **“创建存储帐户”** 边栏选项卡的 **“联网”** 选项卡上查看可用选项，接受默认选项 **“公共终结点(所有网络)”**，然后单击 **“下一步: 数据保护 >”**。

1. 在 **“创建存储帐户”** 边栏选项卡的 **“数据保护”** 选项卡上，查看可用选项，接受默认设置，然后单击 **“下一步: 高级 >”**。

1. 在 **“创建存储帐户”** 边栏选项卡的 **“高级”** 选项卡中，查看可用选项，接受默认设置，然后单击 **“查看 + 创建”**，等待验证过程完成，然后单击 **“创建”**。

    >**注意**：请等待存储帐户创建完成。此操作大约需要 2 分钟。

1. 在部署边栏选项卡上，单击 **“转到资源”** 显示 Azure 存储帐户边栏选项卡。 

1. 在 Azure 存储帐户边栏选项卡的 **“设置”** 部分，单击 **“配置”**。

1. 单击 **“升级”**，将存储帐户类型从 **“存储(常规用途 v1)”** 升级到 **“存储 V2 (常规用途 v2)”**。 

1. 在 **“升级存储帐户”** 边栏选项卡上，查看“升级是永久性的并将产生费用”的警告，在 **“确认升级”** 文本框中，键入存储帐户的名称，然后单击 **“升级”**。 

    > **注意**：你可在预配时选择将帐户类型设置为 **“存储 V2 (常规用途 v2)”**。前两个步骤旨在说明你还可选择升级现有的常规用途 v1 帐户。

    > **注意**：相较于常规用途 v1 帐户，**存储 V2（常规用途 v2）** 具有许多新功能，例如访问分层。

    > **注意**：请查看以下其他配置选项： **“访问层(默认)”**，当前设置为 **“热”**，可更改； **“性能”**，当前设置为 **“标准”**，只能在帐户预配期间设置；**“用于 Azure 文件身份验证的基于标识的目录服务”**，需要 Azure Active Directory 域服务。

1. 在存储帐户边栏选项卡的 **“设置”** 部分，单击 **“异地复制”** 并记下辅助位置。在 **“存储终结点”** 标签下单击 **“全部查看”** 链接，并查看 **“存储帐户终结点”** 边栏选项卡。  

    > **注意**： 不出所料， **“存储帐户终结点”** 边栏选项卡会同时包含主终结点和辅助终结点。

1. 切换到存储帐户的“配置”边栏选项卡，然后在 **“复制”** 下拉列表中选择 **“异地冗余存储(GRS)”** 并保存更改。

1. 切换回 **“异地复制”** 边栏选项卡，并注意仍指定辅助位置。在 **“存储终结点”** 标签下单击 **“全部查看”** 链接，并查看 **“存储帐户终结点”** 边栏选项卡。  

    > **注意**：不出所料， **“存储帐户终结点”** 边栏选项卡仅包含主终结点。

1. 再次显示存储帐户的 **“配置”** 边栏选项卡，在 **“复制”** 下拉列表中选择 **“本地冗余存储(LRS)”** 并保存更改。

1. 切换回 **“异地复制”** 边栏选项卡，请注意，此时存储帐户只有主位置。

1. 再次显示存储帐户的 **“配置”** 边栏选项卡，并将 **“访问层(默认)”** 设置为 **“冷”**。

    > **注意**：对于不经常访问的数据，冷访问层是最佳选择。

#### 任务 3： 管理 Blob 存储

在此任务中，你将创建 blob 容器并在其中上传 blob。 

1. 在存储帐户边栏选项卡上的 **“Blob 服务”** 部分，单击 **“容器”**。

1. 单击 **“+ 容器”** 并使用以下设置创建容器： 

    | 设置 | 值 |
    | --- | --- |
    | 名称 | **az104-07-container**  |
    | 公共访问级别 | **专用（禁止匿名访问）** |

1. 在容器列表中，单击 **az104-07-container**，然后单击 **“上传”**。

1. 浏览到实验室计算机上的 **\\Allfiles\\Module_07\\LICENSE**，然后单击 **“打开”**。

1. 在 **“上传 blob”** 边栏选项卡上，展开 **“高级”** 部分，并指定以下设置（其他设置则保留为默认值）：

    | 设置 | 值 |
    | --- | --- |
    | 身份验证类型 | **帐户密钥**  |
    | blob 类型 | **块 blob** |
    | 块大小 | **4 MB** |
    | 访问层 | **热** |
    | 上传到文件夹 | **licenses** |

    > **注意**：可为每个 blob 设置访问层。

1. 单击 **“上传”**。

    > **注意**：请注意，上传时会自动创建一个名为 **licenses** 的子文件夹。

1. 返回到 **az104-07-container**边栏选项卡，单击 **licenses**，然后单击 **LICENSE**。

1. 在 **licenses/LICENSE** 边栏选项卡上，查看可用选项。 

    > **注意**：你可以选择执行以下操作：下载 blob；更改其访问层（当前设置为 **“冷”**）；获得租约，这会将其租赁状态更改为 **“锁定”**（当前设置为 **“解锁”**）并保护 blob 不被修改或删除；以及分配自定义元数据（通过指定任意键/值对）。也可以在 Azure 门户界面中直接 **“编辑”** 文件，无需先下载。你还可以创建快照以及生成 SAS 令牌（将在下一个任务中探索此选项）。 

#### 任务 4： 管理 Azure 存储的身份验证和授权

在此任务中，你将配置 Azure 存储的身份验证和授权。

1. 在 **licenses/LICENSE** 边栏选项卡的 **“概览”** 选项卡上，单击 **URL** 条目旁边的 **“复制到剪贴板”** 按钮。

1. 使用 InPrivate 模式打开另一个浏览器窗口，并导航到上一步中复制的 URL。 

1. 你应该可以看到一个 XML 格式的消息，显示 **“ResourceNotFound”** 或 **“PublicAccessNotPermitted”**。

    > **注意**：这很正常，因为你创建的容器将公共访问级别设置成了 **“专用(禁止匿名访问)”**。

1. 关闭 InPrivate 模式浏览器窗口，返回到显示 Azure 存储容器 **licenses/LICENSE** 边栏选项卡的浏览器窗口，然后切换到 **“生成 SAS”** 选项卡。

1. 在 **licenses/LICENSE** 边栏选项卡的 **“生成 SAS”** 选项卡上，指定以下设置（其他设置则保留为默认值）：

    | 设置 | 值 |
    | --- | --- |
    | 权限 | **读取** |
    | 开始日期 | 昨天的日期 |
    | 开始时间 | 当前时间 |
    | 到期日期 | 明天的日期 |
    | 到期时间 | 当前时间 |
    | 允许的 IP 地址 | 保留空白 |
    | 允许的协议 | **HTTP** |
    | 签名密钥 | **密钥 1** |

1. 单击 **“生成 SAS 令牌和 URL”**。

1. 单击 **“Blob SAS URL”** 条目旁边的 **“复制到剪贴板”** 按钮。

1. 使用 InPrivate 模式打开另一个浏览器窗口，并导航到上一步中复制的 URL。 

    > **注意**：若使用 Microsoft Edge 或 Internet Explorer，则会显示 **“MIT 许可证(MIT)”** 页面。若使用 Chrome、Microsoft Edge (Chromium) 或 Firefox，则可下载文件并用记事本打开文件以查看内容。

    > **注意**：这很正常，因为你现在的访问基于新生成的 SAS 令牌进行授权。 

    > **注意**：保存 blob SAS URL。稍后将在本实验室用到它。

1. 关闭 InPrivate 模式浏览器窗口，返回到显示 Azure 存储容器 **licenses/LICENSE** 边栏选项卡的浏览器窗口，然后从中导航回 **az104-07-container** 边栏选项卡。

1. 单击 **“身份验证方法”** 标签旁边的 **“切换到 Azure AD 用户帐户”** 链接。

    > **注意**：此时，将无法再访问该容器。 

1. 在 **az104-07-container** 边栏选项卡上，单击 **“访问控制(IAM)”**。

1. 在 **“添加”** 部分，单击 **“添加角色分配”**。

1. 在 **“添加角色分配”** 边栏选项卡上，指定以下设置：

    | 设置 | 值 |
    | --- | --- |
    | 角色 | **存储 blob 数据所有者** |
    | 分配对以下内容的访问权限 | **用户、组或服务主体** |
    | 选择 | 你的用户帐户名称 |

1. 保存更改并返回到 **az104-07-container** 容器的 **“概览”** 边栏选项卡，并确认你可以再次访问该容器。

    > **注意**：更改可能需要大约 5 分钟才生效。
    
#### 任务 5：创建并配置 Azure 文件存储共享

在此任务中，你将创建和配置 Azure 文件存储共享。

   > **注意**：开始本任务前，请确保你在本实验室第一个任务中预配的虚拟机正在运行。

1. 在 Azure 门户中，导航回到你在本实验室第一个任务中创建的存储帐户的边栏选项卡，然后在 **“文件服务”** 部分，单击 **“文件共享”**。

1. 单击 **“+ 文件共享”** 并使用以下设置创建文件共享：

    | 设置 | 值 |
    | --- | --- |
    | 名称 | **az104-07-share** |
    | 配额 | **1024** |

1. 单击新创建的文件共享，然后点击 **“连接”**。

1. 在 **“连接”** 边栏选项卡上，确保选中 **Windows** 选项卡，然后单击 **“复制到剪贴板”**。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在虚拟机列表中，单击 **az104-07-vm0**。

1. 在 **az104-07-vm0** 边栏选项卡上的 **“操作”** 部分，单击 **“运行命令”**。 

1. 在 **“az104-07-vm0 - 运行命令”** 边栏选项卡上，单击 **RunPowerShellScript**。 

1. 在 **“运行命令脚本”** 边栏选项卡上，将先前在此任务中复制的脚本粘贴到 **“PowerShell 脚本”** 窗格并单击 **“运行”**。

1. 验证脚本是否成功完成。 

1. 将 **“PowerShell 脚本”** 窗格中的内容替换为以下脚本，然后单击 **“运行”**：

   ```pwsh
   New-Item -Type Directory -Path 'Z:\az104-07-folder'

   New-Item -Type File -Path 'Z:\az104-07-folder\az-104-07-file.txt'
   ```

1. 验证脚本是否成功完成。 

1. 导航回到 **az104-07-share** 文件共享边栏选项卡，单击 **“刷新”**，并验证 **az104-07-folder** 出现在文件夹列表中。 

1. 单击 **az104-07-folder**，并验证 **az104-07-file.txt** 出现在文件列表中。

#### 任务 6： 管理 Azure 存储的网络访问

在此任务中，你将配置 Azure 存储的网络访问。

1. 在 Azure 门户中，导航回到你在本实验室第一个任务中创建的存储帐户的边栏选项卡，然后在 **“设置”** 部分，单击 **“防火墙和虚拟网络”**。

1. 单击 **“选定的网络”** 选项，并查看启用此选项后可用的配置设置。

    > **注意**：你可以使用这些设置和服务终结点来配置虚拟网络指定子网上的 Azure 虚拟机与存储帐户之间的直接连接。 

1. 单击复选框 **“添加客户端 IP 地址”**，并保存更改。

1. 使用 InPrivate 模式打开另一个浏览器窗口，然后导航到你在上一个任务中生成的 blob SAS URL。 

1. 系统随即显示 **“MIT 许可证(MIT)”** 页面的内容。

    > **注意**：这很正常，因为你从客户端 IP 地址进行连接。

1. 关闭 InPrivate 模式浏览器窗口，返回到显示 Azure 存储容器 **licenses/LICENSE** 边栏选项卡的浏览器窗口，然后打开 Azure Cloud Shell 窗格。

1. 在 Azure 门户中，单击 Azure 门户右上方的图标，打开 **Azure Cloud Shell**。

1. 提示选择 **Bash** 或 **PowerShell** 时，选择 **PowerShell**。 

1. 在 Cloud Shell 窗格中，运行以下命令，尝试从存储帐户的 **az104-07-container** 容器下载 LICENSE blob（将 `[blob SAS URL]` 占位符替换为你在上一个任务中生成的 blob SAS URL）：

   ```pwsh
   Invoke-WebRequest -URI '[blob SAS URL]'
   ```
1. 验证下载尝试是否失败。 

    > **注意**：你会收到消息 **“授权失败: 该请求无权执行此操作”**。这很正常，因为你连接的 IP 地址已分配给托管 Cloud Shell 实例的 Azure VM。

1. 关闭 Cloud Shell 窗格。

#### 清理资源

   >**注意**：请记得删除任何新创建而不会再使用的 Azure 资源。请删除未使用的资源，确保不产生意外费用。

1. 在 Azure 门户中，在 **Cloud Shell** 窗格中打开 **PowerShell** 会话。

1. 运行以下命令，列出在本模块各实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-07*'
   ```

1. 运行以下命令，删除在本模块各个实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-07*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令以异步方式执行（由 -AsJob 参数决定），因此，虽然你随后可在同一 PowerShell 会话中立即运行另一个 PowerShell 命令，但实际上要花几分钟才能删除资源组。

#### 回顾

在本实验室中，你已：

- 预配实验室环境
- 创建和配置 Azure 存储帐户 
- 管理 Blob 存储
- 管理 Azure 存储的身份验证和授权
- 创建和配置 Azure 文件存储共享
- 管理 Azure 存储的网络访问
