---
lab:
    title: '06 - 实现流量管理'
    module: '模块 06 - 网络流量管理'
---

# 实验室 06 - 实现流量管理
# 学生实验室手册

## 实验室场景

你的任务是测试管理流向中心辐射型网络拓扑中 Azure 虚拟机的网络流量，Contoso 考虑在其 Azure 环境中实现该网络拓扑（而不是创建你在前一个实验室中测试的网状拓扑）。此测试需要包括实现辐条之间的连接性，而这将依靠用户定义的路由来实现，这些路由会迫使流量流经中心，以及通过使用第 4 层和第 7 层负载均衡器在虚拟机之间分配流量。为此，你打算使用 Azure 负载均衡器（第 4 层）和 Azure 应用程序网关（第 7 层）。

>**注意**：默认情况下，此实验室在选择部署的区域内 Standard_Dsv3 系列中总共需要 8 个可用的 vCPU，因为其涉及到 Standard_D2s_v3 SKU 四个 Azure VM 的部署。若你的学生使用的是试用帐户（仅限 4 个 vCPU），则你可使用仅需一个 vCPU 的 VM 大小（比如 Standard_B1s）。 

## 目标

在本实验室中，你将：

+ 任务 1：预配实验室环境
+ 任务 2：配置中心辐射型网络拓扑
+ 任务 3：测试虚拟网络对等互连的传递性
+ 任务 4：配置中心辐射型拓扑路由
+ 任务 5：实现 Azure 负载均衡器
+ 任务 6：实现 Azure 应用程序网关

## 预计用时：60 分钟

## 说明

### 练习 1：

#### 任务 1：预配实验室环境

在此任务中，你将把四台虚拟机部署到同一 Azure 区域中。前两个将驻留在中心虚拟网络中，而其余的每个将驻留在单独的辐射虚拟网络中。

1. 登录到 [Azure 门户](https://portal.azure.com)。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

    >**说明**：如果这是你第一次启动 **“Cloud Shell”**，并看到 **“你没有装载存储”** 的消息，请选择你在本实验中使用的订阅，然后单击 **“创建存储”**。 

1. 在“Cloud Shell”窗格的工具栏中，单击 **“上传/下载文件”** 图标，在下拉菜单中，单击 **“上传”** 并上传文件 **“\\Allfiles\\Module_06\\az104-06-vms-template.json”**、 **“\\Allfiles\\Labs\\06\\az104-06-vm-template.json”** 和 **“\\Allfiles\\Labs\\06\\az104-06-vm-parameters.json”** 到 Cloud Shell 主目录中。

1. 在“Cloud Shell”窗格中，运行以下命令以创建第一个资源组，该资源组将托管第一个虚拟网络和一对虚拟机（将 `[Azure_region]` 占位符替换为你打算部署 Azure 虚拟机的 Azure 区域的名称）：

   ```pwsh
   $location = '[Azure_region]'

   $rgName = 'az104-06-rg1'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 在 Cloud Shell 窗格中运行以下命令以创建第一个虚拟网络，并使用之前上传的模板和参数文件在其中部署一对虚拟机：

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vms-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -AsJob
   ```

1. 在“Cloud Shell”窗格中，运行以下命令以创建第二个资源组，该资源组将托管将托管第二个虚拟网络和第三台虚拟机

   ```pwsh
   $rgName = 'az104-06-rg2'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 在“Cloud Shell”窗格中，运行以下命令来创建第二个虚拟网络，并使用你上传的模板和参数文件将一台虚拟机部署到其中：

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 2 `
      -AsJob
   ```
1. 在“Cloud Shell”窗格中，运行以下命令，以创建第三个资源组，该资源组将托管第三个虚拟网络和第四台虚拟机：

   ```pwsh
   $rgName = 'az104-06-rg3'

   New-AzResourceGroup -Name $rgName -Location $location
   ```
1. 在“Cloud Shell”窗格中，运行以下命令，以创建第三个虚拟网络，并使用上传的模板和参数文件将一台虚拟机部署到其中：

   ```pwsh
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vm-template.json `
      -TemplateParameterFile $HOME/az104-06-vm-parameters.json `
      -nameSuffix 3 `
      -AsJob
   ```
    >**注意**：等待部署完成，再执行下一个任务。该操作需约 5 分钟。

    >**说明**：如要验证部署状态，你可检查在此任务中所创建资源组的属性。

1. 关闭 Cloud Shell 窗格。

#### 任务 2：配置中心辐射型网络拓扑

在此任务中，你将在上一个任务中部署的虚拟网络之间配置本地 对等互连，以创建中心辐射型网络拓扑。

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**。

1. 查看你在上一个任务中创建的虚拟网络。 

    >**说明**：用于部署三个虚拟网络的模板可确保三个虚拟网络的 IP 地址范围不重叠。

1. 在虚拟网络列表中，单击 **az104-06-vnet01**。

1. 在 **az104-06-vnet01** 虚拟网络边栏选项卡中的 **“设置”** 部分，单击 **“对等互连”**，然后单击 **“+ 添加”**。

1. 添加一个对等互连，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 从 az104-06-vnet01 到远程虚拟网络的对等互连名称 | **az104-06-vnet01_to_az104-06-vnet2** |
    | 虚拟网络部署模型 | **资源管理器** |
    | 订阅 | 你在本实验中使用的 Azure 订阅的名称 |
    | 虚拟网络 | **az104-06-vnet2 (az104-06-rg2)** |
    | 从 az104-06-vnet2 到 az104-06-vnet01 的对等互连名称 | **az104-06-vnet2_to_az104-06-vnet01** |
    | 允许从 az104-06-vnet01 到 az104-06-vnet2 的虚拟网络访问 | **已启用** |
    | 允许从 az104-06-vnet2 到 az104-06-vnet01 的虚拟网络访问 | **已启用** |
    | 允许流量从 az104-06-vnet2 转发到 az104-06-vnet01 | **禁用** |
    | 允许从 az104-06-vnet01 到 az104-06-vnet2 的转发流量 | **已启用** |
    | 允许网关传输 | **（取消勾选复选框）** |

    >**说明**：等待操作完成。

    >**说明**：此步骤将建立两个本地对等 - 一个从 az104-06-vnet01 到 az104-06-vnet2，另一个从 az104-06-vnet2 到 az104-06-vnet01。

    >**说明**：需要启用 **“允许转发流量”** 以辅助辐射虚拟网络之间的路由，稍后你将在本实验室中实现该网络。

1. 在 **az104-06-vnet01** 虚拟网络边栏选项卡中的 **“设置”** 部分，单击 **“对等互连”**，然后单击 **“+ 添加”**。

1. 添加一个对等互连，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 从 az104-06-vnet01 到远程虚拟网络的对等互连名称 | **az104-06-vnet01_to_az104-06-vnet3** |
    | 虚拟网络部署模型 | **资源管理器** |
    | 订阅 | 你在本实验中使用的 Azure 订阅的名称 |
    | 虚拟网络 | **az104-06-vnet3 (az104-06-rg3)** |
    | 从 az104-06-vnet3 到 az104-06-vnet01 的对等互连名称 | **az104-06-vnet3_to_az104-06-vnet01** |
    | 允许从 az104-06-vnet01 到 az104-06-vnet3 的虚拟网络访问 | **已启用** |
    | 允许从 az104-06-vnet3 到 az104-06-vnet01 的虚拟网络访问 | **已启用** |
    | 允许流量从 az104-06-vnet2 转发到 az104-06-vnet01 | **禁用** |
    | 允许从 az104-06-vnet01 转发流量到 az104-06-vnet3 | **已启用** |
    | 允许网关传输 | **（取消勾选复选框）** |

    >**说明**：此步骤将建立两个本地对等互连 - 一个从 az104-06-vnet01 到 az104-06-vnet3，另一个从 az104-06-vnet3 到 az104-06-vnet01。这样就完成了中心辐射型拓扑（带有两个辐射虚拟网络）的设置。

    >**说明**：需要启用 **“允许转发流量”** 以辅助辐射虚拟网络之间的路由，稍后你将在本实验室中实现该网络。

#### 任务 3：测试虚拟网络对等互连的传递性

在此任务中，你将使用网络观察程序测试虚拟网络对等互连的可传递性。

1. 在 Azure 门户中，搜索并选择 **“网络观察程序”**。

1. 在 **“网络观察程序”** 边栏选项卡中，展开 Azure 区域列表，并验证在本实验室第一项任务中部署了资源的 Azure 已启用该服务。

1. 在 **“网络观察程序”** 的边栏选项卡中，导航到 **“连接故障排除”**。

1. 在 **“网络观察程序 - 连接故障排除”** 边栏选项卡中启动检查，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg1** |
    | 资源类型 | **虚拟机** |
    | 虚拟机 | **az104-06-vm0** |
    | 目标 | **手动指定** |
    | URI、FQDN 或 IPv4 | **10.62.0.4** |
    | 协议 | **TCP** |
    | 目标端口 | **3389** |

    > **注意**：**10.62.0.4** 代表 **az104-06-vm2** 的专用 IP 地址

1. 单击 **“检查”** ，然后等待至返回连接性检查结果。验证状态是否为 **“可访问”**。查看网络路径，注意连接为直连，VM 之间无中间跃点。

    > **注意**：这是预料之中的，因为中心虚拟网络直接与第一个辐射虚拟网络对等互连。

    > **注意**：初始检查可能需要 2 分钟左右，因为它需要在 **az104-06-vm0** 上面安装网络观察程序代理虚拟机扩展 。

1. 在 **“网络观察程序 - 连接故障排除”** 边栏选项卡中启动检查，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg1** |
    | 源类型 | **虚拟机** |
    | 虚拟机 | **az104-06-vm0** |
    | 目标 | **手动指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 协议 | **TCP** |
    | 目标端口 | **3389** |

    > **注意**：**10.63.0.4** 代表 **az104-06-vm3** 的专用 IP 地址

1. 点击 **“检查”** ，然后等待至返回连接性检查结果。验证状态是否为 **“可访问”**。查看网络路径并注意连接是否为直连，VM 之间是否无中间跃点。

    > **注意**：这是预料之中的，因为中心虚拟网络直接与第二个辐射虚拟网络对等互连。

1. 在 **“网络观察程序 - 连接故障排除”** 边栏选项卡中启动检查，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg2** |
    | 源类型 | **虚拟机** |
    | 虚拟机 | **az104-06-vm2** |
    | 目标 | **手动指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 协议 | **TCP** |
    | 目标端口 | **3389** |

1. 点击 **“检查”** ，然后等待至返回连接性检查结果。请注意，状态为 **“无法访问”**。 

    > **注意**：这是预料之中的，因为两个辐射虚拟网络不会彼此互连（虚拟网络对等互连不可传递）。

#### 任务 4：配置中心辐射型拓扑路由

在此任务中，你将通过在虚拟机 **az104-06-vm0** 的网络接口上启用 IP 转发来配置和测试两个辐射虚拟网络之间的路由，在虚拟机的操作系统内启用路由，并在辐射虚拟网络上配置用户定义的路由。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**。

1. 在 **“虚拟机”** 边栏选项卡的虚拟机列表中，单击 **“az104-06-vm0”**。

1. 在 **“az104-06-vm0”** 虚拟机边栏选项卡的 **“设置”** 部分，单击 **“网络”**。

1. 单击 **“网络接口”** 标签旁的 **az104-06-nic0** 链接 ，然后在 **az104-06-nic0** 网络接口边栏选项卡上的 **“设置”** 部分，单击 **“IP 配置”**。 

1. 将 **“IP 转发”** 设置为 **“已启用”** 并保存更改。 

   > **注意**：为了让 **az104-06-vm0** 充当路由器，此设置是必需，它将在两个辐射虚拟网络之间路由流量。

   > **注意**：现在你需要配置虚拟机 **az104-06-vm0** 的操作系统来支持路由。

1. 在 Azure 门户中，导航到 **“az104-06-vm0”** Azure 虚拟机边栏选项卡，并单击 **“概述”**。

1. 在 **“az104-06-vm0”** 边栏选项卡的 **“操作”** 部分，单击 **“运行命令”**，然后在命令列表中，单击 **“RunPowerShellScript”**。

1. 在 **“运行命令脚本”** 边栏选项卡中输入以下内容，然后单击 **“运行”** 来安装远程访问窗口服务器角色。

   ```pwsh
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **注意**：等待确认命令已成功完成。

1. 在 **“运行命令脚本”** 边栏选项卡中输入以下内容，然后单击 **“运行”** 来安装路由角色服务。

   ```pwsh
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **注意**：等待确认命令已成功完成。

   > **注意**：现在，需要在辐射虚拟网络上创建和配置用户定义的路由。

1. 在 Azure 门户中，搜索并选择 **“路由表”**，并且在 **“路由表”** 边栏选项卡中单击 **“+ 添加”**。

1. 创建一个路由表，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-rt23** |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg2** |
    | 位置 | 你创建的虚拟网络所在的 Azure 区域的名称 |
    | 虚拟网络网关路由传播 | **禁用** |

   > **注意**：等待创建新的路由表。该操作需约 3 分钟。

1. 返回到 **“路由表”** 边栏选项卡，单击 **“刷新”**，然后单击 **az104-06-rt23**。

1. 在 **az104-06-rt23** “路由表”边栏选项卡上，单击 **“路由”**，然后单击 **“+ 添加”**。

1. 添加一个新路由，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 路由名称 | **az104-06-route-vnet2-to-vnet3** |
    | 地址前缀 | **10.63.0.0/20** |
    | 下一个跃点类型 | **虚拟设备** |
    | 下一个跃点地址 | **10.60.0.4** |

1. 返回到 **az104-06-rt23** “路由表”边栏选项卡上，单击 **“子网”** ，然后单击 **“+ 关联”**。

1. 关联路由表 **az104-06-rt23** ，该路由表具有以下子网：

    | 设置 | 数值 |
    | --- | --- |
    | 虚拟网络 | **az104-06-vnet2** |
    | 子网 | **subnet0** |

1. 返回 **“路由表”** 边栏选项卡，并单击 **“+ 添加”**。

1. 创建一个路由表，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-rt32** |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg3** |
    | 位置 | 你创建的虚拟网络所在的 Azure 区域的名称 |
    | 虚拟网络网关路由传播 | **禁用** |

   > **注意**：等待创建新的路由表。该操作大约需要 3 分钟。

1. 返回到 **“路由表”** 边栏选项卡，单击 **“刷新”**，然后单击 **“az104-06-rt32”**。

1. 在 **“az104-06-rt32”** 路由表边栏选项卡，单击 **“路由”**，然后单击 **“+ 添加”**。

1. 添加一个新路由，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 路由名称 | **az104-06-route-vnet3-to-vnet2** |
    | 地址前缀 | **10.62.0.0/20** |
    | 下一个跃点类型 | **虚拟设备** |
    | 下一个跃点地址 | **10.60.0.4** |

1. 返回到 **“az104-06-rt32”** 路由表边栏选项卡上，单击 **“子网”**， 然后单击 **“+ 关联”**。

1. 关联路由表 **“az104-06-rt32”** 和以下子网：

    | 设置 | 数值 |
    | --- | --- |
    | 虚拟网络 | **az104-06-vnet3** |
    | 子网 | **subnet0** |

1. 在 Azure 门户中，返回 **“网络观察程序 - 连接故障排除”** 边栏选项卡。

1. 在 **“网络观察程序 - 连接故障排除”** 边栏选项卡中启动检查，设置如下（其他设置则保留默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-06-rg2** |
    | 资源类型 | **虚拟机** |
    | 虚拟机 | **az104-06-vm2** |
    | 目标 | **手动指定** |
    | URI、FQDN 或 IPv4 | **10.63.0.4** |
    | 协议 | **TCP** |
    | 目标端口 | **3389** |

1. 单击 **“检查”**，然后等待，直到返回连接检查的结果。验证状态为 **“可达”**。查看网络路径，并注意流量是通过分配给 **az104-06-nic0** 网络适配器的 **10.60.0.4** 路由的。如果状态为 **“可达”**，则你应重新启动 az104-06-vm0。


    > **注意**：这是预料之中的，因为辐射虚拟网络之间的流量现在是通过位于中心虚拟网络中的虚拟机路由的，由该虚拟机充当路由器。 

    > **注意**：你可以使用 **“网络观察程序”** 查看网络拓扑。

#### 任务 5：实现 Azure 负载均衡器

在此任务中，你将在中心虚拟网络中的两台 Azure 虚拟机前实现 Azure 负载均衡器

1. 在 Azure 门户中，搜索并选择 **“负载均衡器”**，在 **“负载均衡器”** 边栏选项卡上，单击 **“+ 添加”**。

1. 创建负载均衡器，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 一个新资源组的名称 **az104-06-rg4** |
    | 名称 | **az104-06-lb4** |
    | 区域| 在此实验室中部署所有其他资源的 Azure 区域的名称 |
    | 类型 | **公共** |
    | SKU | **标准** |
    | 公共 IP 地址 | **新建** |
    | 公共 IP 地址名称 | **az104-06-pip4** |
    | 可用性区域 | **区域冗余** |
    | 添加公共 IPv6 地址 | **否** |

    > **注意**：等待预配 Azure 负载均衡器。该操作大约需要 2 分钟。 

1. 在“部署”边栏选项卡中，单击 **“前往资源”**。

1. 在 **az104-06-lb4** 负载均衡器边栏选项卡，单击 **“后端池”**，然后点击 **“+ 添加”**。

1. 添加后端池并进行如下设置（保留其他默认设置）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-lb4-be1** |
    | 虚拟网络 | **az104-06-vnet01** |
    | IP 版本 | **IPv4** |
    | 虚拟机 | **az104-06-vm0** | 
    | 虚拟机 IP 地址 | **ipconfig1 (10.60.0.4)** |
    | 虚拟机 | **az104-06-vm1** |
    | 虚拟机 IP 地址 | **ipconfig1 (10.60.1.4)** |

1. 等待后端池创建完毕，单击 **“运行状况探测”**，然后单击 **“+ 添加”**。

1. 使用以下设置添加一个运行状况探测（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-lb4-hp1** |
    | 协议 | **TCP** |
    | 端口 | **80** |
    | 间隔 | **5** |
    | 不正常阈值 | **2** |

1. 等待创建“运行状况探测”，单击 **“负载平衡规则”**，然后单击 **“+ 添加”**。

1. 添加负载平衡规则，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-lb4-lbrule1** |
    | IP 版本 | **IPv4** |
    | 协议 | **TCP** |
    | 端口 | **80** |
    | 后端端口 | **80** |
    | 后端池 | **az104-06-lb4-be1** |
    | 运行状况探测 | **az104-06-lb4-hp1** |
    | 会话持续性 | **无** |
    | 空闲超时（分钟） | **4** |
    | TCP 重置 | **禁用** |
    | 浮动 IP（直接服务器返回） | **禁用** |
    | 创建隐式出站规则 | **是** |

1. 等待负载均衡规则创建完毕，单击 **“概述”**，并记下 **“公用 IP 地址”** 的值。

1. 启动另一个浏览器窗口，并导航到你在上一步中标识的 IP 地址。

1. 验证浏览器窗口是否显示消息 **Hello World from az104-06-vm0** 或者 **Hello World from az104-06-vm1**。

1. 打开另一个浏览器窗口，但这一次使用“InPrivate ”模式，并验证目标 vm 是否更改（如消息所示）。 

    > **注意**：你可能需要刷新浏览器窗口，或使用“InPrivate”模式再次打开它。

#### 任务 6：实现 Azure 应用程序网关

在此任务中，将在辐射虚拟网络中的两台 Azure 虚拟机前实现 Azure 应用程序网关。

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**。

1. 在 **“虚拟网络”** 边栏选项卡的虚拟网络列表中，单击 **az104-06-vnet01**。

1. 在 **az104-06-vnet01** 虚拟网络边栏选项卡上的 **“设置”** 部分，单击 **“子网”**，然后单击 **“+ 子网”**。

1. 添加一个子网，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **subnet-appgw** |
    | 地址范围（CIDR 块） | **10.60.3.224/27** |
    | 网络安全组 | **无** |
    | 路由表 | **无** |

    > **注意**：此子网将由 Azure 应用程序网关实例使用，稍后将在此任务中进行部署。应用程序网关需要一个专用子网 /27 或更大的大小。

1. 在 Azure 门户中，搜索并选择 **“应用程序网关”**， 并且在 **“应用程序网关”** 边栏选项卡中，单击 **“+ 添加”**。

1. 在 **“创建应用程序网关”** 边栏选项卡的 **“基本”** 选项卡，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 一个新资源组的名称**az104-06-rg5** |
    | 应用程序网关名称 | **az104-06-appgw5** |
    | 区域 | 在此实验室中部署所有其他资源的 Azure 区域的名称 |
    | 层级 | **标准 V2** |
    | 启用自动缩放 | **否** |
    | 缩放单元 | **1** |
    | 可用性区域 | **1, 2, 3** |
    | HTTP2 | **禁用** |
    | 虚拟网络 | **az104-06-vnet01** |
    | 子网 | **subnet-appgw** |

1. 单击 **“下一步： 前端 >”**，并在 **“创建一个应用程序网关”** 边栏选项卡的 **“前端”** 选项卡上，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 前端 IP 地址类型 | **公共** |
    | 防火墙公共 IP 地址 | 新公共 IP 地址的名称 **az104-06-pip5** |

1. 单击 **“下一步: 后端 >”**，在 **“创建应用程序网关”** 边栏选项卡的 **“后端”** 选项卡上，单击 **“添加后端池”**，然后在 **“添加后端池”** 边栏选项卡上，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-06-appgw5-be1** |
    | 添加不包含目标的后端池 | **否** |
    | 目标类型 | **IP 地址或 FQDN** |
    | 目标 | **10.62.0.4** |
    | 目标类型 | **IP 地址或 FQDN** |
    | 目标 | **10.63.0.4** |

    > **注意**：目标代表辐射虚拟网络 **az104-06-vm2** 和 **az104-06-vm3** 中虚拟机的专用 IP 地址 。

1. 单击 **“添加”**，单击 **“下一个： 配置 >”**，并且在 **“创建应用程序网关”** 边栏选项卡的 **“配置”** 选项卡上，单击 **“+ 添加路由规则”**。 

1. 在 **“添加路由规则”** 边栏选项卡的 **“侦听器”** 选项卡上，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 规则名称 | **az104-06-appgw5-rl1** |
    | 侦听器名称 | **az104-06-appgw5-rl1l1** |
    | 前端 IP | **公共** |
    | 协议 | **HTTP** |
    | 端口 | **80** |
    | 侦听器类型 | **基本** |
    | 错误页面 URL | **否** |

1. 切换到 **“添加一个路由规则”** 边栏选项卡的 **“后端目标”** 选项卡，并指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 目标类型 | **后端池** |
    | 后端目标 | **az104-06-appgw5-be1** |

1. 在 **“添加路由规则”** 边栏选项卡的 **“后端目标”** 选项卡上 ，单击 **“HTTP 设置”** 文本框旁边的 **“新增”**，然后在 **“添加 HTTP 设置”** 边栏选项卡上，指定以下设置（其他设置保留为默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | HTTP 设置名称 | **az104-06-appgw5-http1** |
    | 后端协议 | **HTTP** |
    | 后端端口 | **80** |
    | 基于 Cookie 的相关性 | **禁用** |
    | 连接耗尽 | **禁用** |
    | 申请超时（秒） | **20** |

1. 单击 **“添加 HTTP 设置”** 边栏选项卡的 **“添加”**，然后返回到 **“添加路由规则”** 边栏选项卡，单击 **“添加”**。

1. 单击 **“下一步： 标记>”**， 接着是 **“下一步： 查看 + 创建”**，然后单击 **“创建”**。

    > **注意**：等待应用程序网关实例创建完毕。该操作需要约 8 分钟。

1. 在 Azure 门户中，搜索并选择 **“应用程序网关”**，并且在 **“应用程序网关”** 边栏选项卡上，单击 **“az104-06-appgw5”**。

1. 在 **“az104-06-appgw5”** 应用程序网关边栏选项卡上，记下 **“前端公用 IP 地址”** 的值。

1. 启动另一个浏览器窗口，并导航到你在上一步中标识的 IP 地址。

1. 验证浏览器窗口是否显示消息 **Hello World from az104-06-vm2** 或 **Hello World from az104-06-vm3**。

1. 打开另一个浏览器窗口，但这次使用 InPrivate 模式打开，并验证目标 VM 是否更改（基于网页上显示的消息）。 

    > **注意**：你可能需要刷新浏览器窗口，或使用“InPrivate”模式再次打开它。

    > **注意**：把多个虚拟网络上的虚拟机作为目标不是一种常见配置，但这是为了说明应用程序网关能够把多个虚拟网络（以及其他 Azure 区域甚至 Azure 外部的终结点）上的虚拟机作为目标。这与 Azure 负载均衡器不同，Azure 负载均衡器的功能是在同一虚拟网络中的各个虚拟机之间实现负载平衡。

#### 清理资源

   >**说明**：请记得移除任何你不再使用的新创建的 Azure 资源。移除未使用的资源，确保不产生意外费用。

1. 在 Azure 门户中，打开 **“Cloud Shell”** 窗格中的 **“PowerShell”** 会话。

1. 通过运行以下命令，列出在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-06*'
   ```

1. 通过运行以下命令，删除在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-06*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令异步执行（由 -AsJob 参数确定），因此尽管此后你可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能移除资源组。

#### 回顾

在本实验室中，你已：

- 预配实验室环境
- 配置中心辐射型网络拓扑
- 测试虚拟网络对等互连的可传递性
+ 任务 4：配置中心辐射型拓扑路由
+ 任务 5：实现 Azure 负载均衡器
+ 任务 6：实现 Azure 应用程序网关
